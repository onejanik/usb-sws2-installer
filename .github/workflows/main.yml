name: Build Executables
on:
  push:
    branches:
      - main
jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ['windows-latest', 'ubuntu-latest', 'macos-latest']
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk python3-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executable with assets
      run: |
        pyinstaller main.py --icon=favicon.ico --onefile --add-data "index.html;." --add-data "favicon.ico;." --add-data "assets;assets" --name "SubwaySim2_USB_Installer"
      if: matrix.os != 'windows-latest'
    
    - name: Build executable with assets (Windows)
      run: |
        pyinstaller main.py --icon=favicon.ico --onefile --add-data "index.html;." --add-data "favicon.ico;." --add-data "assets;assets" --name "SubwaySim2_USB_Installer"
      if: matrix.os == 'windows-latest'
    
    # Generate and use self-signed certificate for Windows
    - name: Generate and sign Windows executable
      if: matrix.os == 'windows-latest'
      run: |
        # Generate a self-signed certificate
        $cert = New-SelfSignedCertificate -DnsName "SubwaySim2-USB-Installer" -Type CodeSigning -CertStoreLocation "Cert:\CurrentUser\My" -Subject "CN=SubwaySim2 USB Installer"
        $password = ConvertTo-SecureString -String "TempPassword123!" -Force -AsPlainText
        $certPath = "selfsigned.pfx"
        Export-PfxCertificate -Cert $cert -FilePath $certPath -Password $password
        
        # Find signtool
        $signtoolPath = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\*\bin\*\x64\signtool.exe" -Recurse | Select-Object -First 1
        
        if ($signtoolPath) {
          Write-Host "Found signtool at: $($signtoolPath.FullName)"
          # Sign the executable
          & $signtoolPath.FullName sign /f $certPath /p "TempPassword123!" /tr http://timestamp.sectigo.com /td SHA256 /fd SHA256 "dist\SubwaySim2_USB_Installer.exe"
          Write-Host "Windows executable signed with self-signed certificate"
        } else {
          Write-Host "signtool.exe not found, skipping signing"
        }
        
        # Clean up certificate files
        Remove-Item $certPath -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path "Cert:\CurrentUser\My" | Where-Object { $_.Subject -like "*SubwaySim2*" } | Remove-Item -Force -ErrorAction SilentlyContinue
      shell: pwsh
    
    # Generate and use self-signed certificate for macOS
    - name: Generate and sign macOS executable
      if: matrix.os == 'macos-latest'
      run: |
        # Create a self-signed certificate for code signing
        security create-keychain -p actions build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p actions build.keychain
        
        # Generate certificate
        security add-certificates -k build.keychain /System/Library/Keychains/SystemRootCertificates.keychain
        
        # Create a self-signed certificate (this won't pass Gatekeeper but reduces some warnings)
        cat > cert.conf << EOF
        [req]
        distinguished_name = req_distinguished_name
        x509_extensions = v3_req
        prompt = no

        [req_distinguished_name]
        CN = SubwaySim2 USB Installer
        O = SubwaySim2 Development
        C = US

        [v3_req]
        keyUsage = keyEncipherment, dataEncipherment, digitalSignature
        extendedKeyUsage = codeSigning
        EOF
        
        openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes -config cert.conf
        openssl pkcs12 -export -out certificate.p12 -inkey key.pem -in cert.pem -passout pass:actions
        
        security import certificate.p12 -k build.keychain -P actions -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain
        
        # Try to sign (may fail due to lack of proper provisioning, but that's expected for self-signed)
        codesign --force --sign "SubwaySim2 USB Installer" --timestamp --options runtime "dist/SubwaySim2_USB_Installer" || echo "Code signing failed (expected for self-signed cert)"
        
        # Clean up
        rm -f cert.conf key.pem cert.pem certificate.p12
        security delete-keychain build.keychain || true
      shell: bash
    
    # Generate GPG signature for Linux
    - name: Generate GPG signature (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Generate a temporary GPG key for signing
        cat > gpg-batch << EOF
        Key-Type: RSA
        Key-Length: 2048
        Name-Real: SubwaySim2 USB Installer
        Name-Email: installer@subwaysim2.local
        Expire-Date: 0
        Passphrase: TempPassword123
        %commit
        EOF
        
        gpg --batch --generate-key gpg-batch
        
        # Sign the executable
        echo "TempPassword123" | gpg --batch --yes --passphrase-fd 0 --detach-sign --armor "dist/SubwaySim2_USB_Installer"
        echo "Linux executable signed with GPG"
        
        # Clean up
        rm -f gpg-batch
      shell: bash
    
    - name: Create Artifact (Windows)
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: windows-executables
        path: dist/
        retention-days: 30
    
    - name: Create Artifact (Linux)
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: linux-executables
        path: dist/
        retention-days: 30
    
    - name: Create Artifact (macOS)
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: macos-executables
        path: dist/
        retention-days: 30
    
    - name: List final build artifacts (Windows)
      if: matrix.os == 'windows-latest'
      run: Get-ChildItem -Path "./dist/" -Force
      shell: pwsh
    
    - name: List final build artifacts (Unix)
      if: matrix.os != 'windows-latest'
      run: ls -la ./dist/
