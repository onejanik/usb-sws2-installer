name: Build GUI Executables
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ['windows-latest', 'ubuntu-latest', 'macos-latest']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install system dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk python3-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    
    - name: Build with Nuitka (Windows GUI)
      if: matrix.os == 'windows-latest'
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: main.py
        mode: app
        output-dir: build
        output-file: SubwaySim2_USB_Installer.exe
        windows-console-mode: disable
        windows-icon-from-ico: favicon.ico
        company-name: "FärberIT Solutions"
        product-name: "SubwaySim2 USB Installer"
        file-version: "1.0.0.0"
        product-version: "1.0.0"
        file-description: "U-Bahn Berlin Mod Installer - GUI"
        copyright: "© 2025 FärberIT Solutions"
        assume-yes-for-downloads: true
        include-data-files: |
          index.html=index.html
          favicon.ico=favicon.ico
        include-data-dir: assets=assets
        enable-plugins: pywebview
        onefile-tempdir-spec: "{CACHE_DIR}/{COMPANY}/{PRODUCT}/{VERSION}"

    
    - name: Build with Nuitka (Linux GUI)
      if: matrix.os == 'ubuntu-latest'
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: main.py
        mode: app
        output-dir: build
        output-file: SubwaySim2_USB_Installer.bin
        assume-yes-for-downloads: true
        include-data-files: |
          index.html=index.html
          favicon.ico=favicon.ico
        include-data-dir: assets=assets
    
    - name: Build with Nuitka (macOS GUI)
      if: matrix.os == 'macos-latest'
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: main.py
        mode: app
        output-dir: build
        output-file: SubwaySim2_USB_Installer.bin
        macos-app-icon: favicon.ico
        assume-yes-for-downloads: true
        include-data-files: |
          index.html=index.html
          favicon.ico=favicon.ico
        include-data-dir: assets=assets
    
   
    - name: Sign Windows executable
      if: matrix.os == 'windows-latest'
      env:
        CERTIFICATE_BASE64: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}
        CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
      run: |
        $certBytes = [Convert]::FromBase64String($env:CERTIFICATE_BASE64)
        $certPath = "signing-cert.pfx"
        [IO.File]::WriteAllBytes($certPath, $certBytes)
        
        $signtoolPath = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\*\bin\*\x64\signtool.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        
        if (-not $signtoolPath) {
          Write-Error "signtool.exe nicht gefunden!"
          exit 1
        }
        
        $exePath = Get-ChildItem -Path "build" -Filter "*.exe" | Select-Object -First 1
        
        if (-not $exePath) {
          Write-Error "Keine EXE gefunden!"
          exit 1
        }
        
        Write-Host "Signiere: $($exePath.FullName)"
        
        & $signtoolPath.FullName sign `
          /f $certPath `
          /p $env:CERTIFICATE_PASSWORD `
          /tr http://timestamp.digicert.com `
          /td SHA256 `
          /fd SHA256 `
          /d "SubwaySim2 USB Installer" `
          /du "https://github.com/${{ github.repository }}" `
          $exePath.FullName
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Signierung fehlgeschlagen!"
          exit 1
        }
        
        Write-Host "✓ GUI-Executable signiert!"
        Remove-Item $certPath -Force
      shell: pwsh
    
    
    
    - name: Prepare Linux executable
      if: matrix.os == 'ubuntu-latest'
      run: |
        chmod +x build/*.bin
        ls -lh build/
    
    - name: Prepare macOS executable
      if: matrix.os == 'macos-latest'
      run: |
        chmod +x build/*.bin
        ls -lh build/
    
    
    - name: Upload Windows artifact
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: SubwaySim2_USB_Installer_GUI_Windows
        path: build/*.exe
        retention-days: 90
    
    - name: Upload Linux artifact
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: SubwaySim2_USB_Installer_GUI_Linux
        path: build/*.bin
        retention-days: 90
    
    - name: Upload macOS artifact
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: SubwaySim2_USB_Installer_GUI_macOS
        path: build/*.bin
        retention-days: 90
    
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: build/*
        draft: false
        prerelease: false
        body: |
          ## SubwaySim2 USB Installer - GUI Version
          
          ### Download
          
          - **Windows:** `SubwaySim2_USB_Installer.exe` (signiert)
          - **Linux:** `SubwaySim2_USB_Installer.bin`
          - **macOS:** `SubwaySim2_USB_Installer.bin`
          
          ### Installation
          
          #### Windows
          1. EXE herunterladen
          2. Doppelklick zum Starten
          3. Falls SmartScreen warnt: "Weitere Informationen" → "Trotzdem ausführen"
          
          #### Linux
          ```
          chmod +x SubwaySim2_USB_Installer.bin
          ./SubwaySim2_USB_Installer.bin
          ```
          
          #### macOS
          ```
          chmod +x SubwaySim2_USB_Installer.bin
          ./SubwaySim2_USB_Installer.bin
          ```
          
          Falls macOS Sicherheitswarnung: Systemeinstellungen → Sicherheit → "Trotzdem öffnen"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
